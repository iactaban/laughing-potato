<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker Pro</title>
    <!-- Include Chart.js for progression graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Dark Theme with Orange/Cyan Accents --- */
        :root {
            --bg-primary: #1a1d21;
            --bg-secondary: #25282e;
            --bg-tertiary: #31353d;
            --text-primary: #e1e1e1;
            --text-secondary: #a0a0a0;
            --border-color: #444850;
            --accent-orange: #ff9800; /* Main Accent */
            --accent-cyan: #00bcd4;   /* Secondary Accent */
            --accent-red: #e53935;
            --accent-green: #43a047;
        }

        /* General Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        h1, h2 {
            color: var(--accent-orange);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        h3 {
             color: var(--accent-orange);
        }
        
        /* Form Styling & General Controls */
        form { display: flex; flex-direction: column; gap: 15px; }
        .form-row { display: flex; gap: 15px; }
        .form-row input[type="date"] { flex-grow: 1; }
        input, select, button { 
            padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; 
            font-size: 1em; background-color: var(--bg-tertiary); color: var(--text-primary);
        }
        input::placeholder { color: var(--text-secondary); }
        button {
            background-color: var(--accent-orange); color: #111; font-weight: bold;
            border: none; cursor: pointer; transition: background-color 0.3s;
        }
        button:hover { background-color: #f57c00; }
        .add-exercise-btn { background-color: var(--accent-green); }
        .add-exercise-btn:hover { background-color: #388e3c; }
        .action-btn { font-size: 0.8em; padding: 5px 10px; margin-left: 5px; }
        .delete-btn { background-color: var(--accent-red); }
        .delete-btn:hover { background-color: #d32f2f; }
        .edit-btn { background-color: var(--accent-cyan); }
        .edit-btn:hover { background-color: #00acc1; }
        .remove-exercise-btn { background-color: var(--accent-orange); color: white; border: none; padding: 0 10px; border-radius: 5px; cursor: pointer; }
        
        /* Exercise Input Group */
        .exercise-group {
            border: 1px dashed var(--border-color); padding: 15px; border-radius: 5px;
            display: grid; grid-template-columns: 1fr repeat(2, 80px) 1.5fr auto;
            gap: 10px; align-items: center;
        }
        .weight-input-group {
            display: grid; grid-template-columns: auto 1fr auto 90px;
            gap: 5px; align-items: center;
        }
        .weight-adjust-btn {
            padding: 0; width: 35px; height: 35px; font-size: 1.2em; line-height: 1;
            background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color);
        }
        .weight-adjust-btn:hover { background-color: #4a4e56; }
        .weight-adjust-btn:disabled { background-color: var(--bg-primary); color: var(--text-secondary); cursor: not-allowed; }
        .exercise-weight { text-align: center; padding: 12px 5px; -moz-appearance: textfield; }
        .exercise-weight::-webkit-outer-spin-button, .exercise-weight::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* History and PRs */
        #workout-history, #personal-records { margin-top: 30px; }
        .workout-category-section { margin-bottom: 25px; }
        .workout-item {
            background: var(--bg-tertiary); padding: 15px; border-radius: 5px;
            margin-bottom: 10px; border-left: 5px solid var(--accent-orange); position: relative;
        }
        .workout-item-header { display: flex; justify-content: space-between; align-items: center; }
        .workout-item-header h4 { margin: 0; font-size: 1.1em; }
        .workout-item ul { padding-left: 20px; margin-bottom: 0; }
        .workout-item li { cursor: pointer; transition: color 0.2s; }
        .workout-item li:hover { color: var(--accent-cyan); font-weight: bold; }
        .empty-state { color: var(--text-secondary); text-align: center; padding: 20px; }
        .edit-controls { margin-top: 10px; }

        /* Table Styling */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border-color); }
        th { background-color: #31353d; color: var(--accent-orange); }

        /* Modal for Chart */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--bg-secondary); border: 1px solid var(--border-color);
            margin: auto; padding: 20px; width: 80%; max-width: 700px;
            border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: var(--text-primary); }
        .chart-controls { text-align: center; margin-bottom: 10px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .chart-controls p { margin: 0 0 5px 0; font-weight: bold; color: var(--accent-orange); }
        .chart-controls button { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .chart-controls button:hover { background-color: #4a4e56; }

        /* All-Time History View */
        .view-switch-btn { margin-top: 20px; background-color: var(--accent-cyan); }
        .view-switch-btn:hover { background-color: #00acc1; }
        #all-time-history-view { display: none; }
        .history-filters {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;
            padding: 15px; background-color: var(--bg-tertiary); border-radius: 5px; margin-bottom: 20px;
        }
        .history-filters label { display: block; margin-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="main-app-view" class="container">
        <h1>Workout Tracker Pro üèãÔ∏è</h1>

        <!-- Workout Input Form -->
        <form id="workout-form">
            <h2>Log a New Workout</h2>
            <div class="form-row">
                <input type="date" id="workout-date" required>
                <select id="workout-type" required>
                    <option value="strength">Strength Training</option>
                    <option value="stretch">Stretch Training</option>
                    <option value="pump">Pump Training</option>
                </select>
            </div>
            <div id="exercises-container"></div>
            <button type="button" class="add-exercise-btn" onclick="addExerciseField()">+ Add Another Exercise</button>
            <button type="submit">Save Workout</button>
        </form>

        <!-- Personal Records Section -->
        <div id="personal-records">
            <h2>Personal Records (Max Weight)</h2>
            <table id="pr-table">
                <thead><tr><th>Exercise</th><th>Max Weight (kg)</th><th>Date Achieved</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Workout History Section -->
        <div id="workout-history">
            <h2>This Week's History</h2>
            <div id="strength-history" class="workout-category-section">
                <h3>Strength Training</h3>
                <div class="history-list"></div>
            </div>
            <div id="stretch-history" class="workout-category-section">
                <h3>Stretch Training</h3>
                <div class="history-list"></div>
            </div>
            <div id="pump-history" class="workout-category-section">
                <h3>Pump Training</h3>
                <div class="history-list"></div>
            </div>
        </div>
        <button class="view-switch-btn" onclick="showHistoryView()">View All-Time History</button>
    </div>

    <div id="all-time-history-view" class="container">
        <h2>All-Time History</h2>
        <div class="history-filters">
            <div>
                <label for="filter-type">Filter by Type</label>
                <select id="filter-type">
                    <option value="all">All Types</option>
                    <option value="strength">Strength Training</option>
                    <option value="stretch">Stretch Training</option>
                    <option value="pump">Pump Training</option>
                </select>
            </div>
            <div>
                <label for="sort-date">Sort by Date</label>
                <select id="sort-date">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                </select>
            </div>
            <div>
                <label for="search-exercise">Search by Exercise</label>
                <input type="text" id="search-exercise" placeholder="e.g., Bench Press">
            </div>
        </div>
        <div id="all-time-history-list"></div>
        <button class="view-switch-btn" onclick="showMainView()">Back to Main</button>
    </div>

    <!-- Chart Modal -->
    <div id="chart-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="chart-title">Exercise Progression</h3>
            <canvas id="progression-chart"></canvas>
            <div class="chart-controls">
                <p>Data Type</p>
                <button id="weight-chart-btn" onclick="showWeightChart()">Weight</button>
                <button id="reps-chart-btn" onclick="showRepsChart()">Total Reps</button>
            </div>
            <div class="chart-controls">
                <p>Chart Style</p>
                <button onclick="setChartStyle('bar')">Bar</button>
                <button onclick="setChartStyle('fancy')">Styled</button>
            </div>
        </div>
    </div>

    <script>
        // --- Globals & DOM Elements ---
        let db;
        let chartInstance;
        let currentProgressionData = [];
        let currentChartType = 'weight';
        let currentChartStyle = 'fancy';
        
        const mainAppView = document.getElementById('main-app-view');
        const allTimeHistoryView = document.getElementById('all-time-history-view');
        
        const form = document.getElementById('workout-form');
        const dateInput = document.getElementById('workout-date');
        const typeInput = document.getElementById('workout-type');
        const exercisesContainer = document.getElementById('exercises-container');
        const prTableBody = document.querySelector('#pr-table tbody');
        const chartModal = document.getElementById('chart-modal');

        // All-Time History Controls
        const filterTypeEl = document.getElementById('filter-type');
        const sortDateEl = document.getElementById('sort-date');
        const searchExerciseEl = document.getElementById('search-exercise');
        const allTimeHistoryList = document.getElementById('all-time-history-list');

        // --- Database Setup ---
        const request = indexedDB.open("WorkoutDB", 5);

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            if (!db.objectStoreNames.contains('workouts')) {
                const store = db.createObjectStore("workouts", { keyPath: "id", autoIncrement: true });
                store.createIndex('type', 'type', { unique: false });
            }
            if (!db.objectStoreNames.contains('personalRecords')) {
                db.createObjectStore("personalRecords", { keyPath: "exerciseName" });
            }
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            console.log("Database opened successfully.");
            setInitialDate();
            resetAndAddFirstExercise();
            loadWorkouts();
            loadPRs();
            setupHistoryEventListeners();
        };

        request.onerror = (e) => console.error("Database error: ", e.target.errorCode);
        
        // --- Form & UI Functions ---
        function setInitialDate() {
            dateInput.value = new Date().toISOString().split('T')[0];
        }

        function createExerciseFieldHtml(exercise = {}) {
            const name = exercise.name || '';
            const sets = exercise.sets || '';
            const reps = exercise.reps || '';
            const weight = exercise.unit === 'bw' ? '' : (exercise.weight || '');
            const unit = exercise.unit || 'kg';
            const isBw = unit === 'bw';

            return `
                <input type="text" class="exercise-name" placeholder="Exercise Name" value="${name}" required>
                <input type="number" class="exercise-sets" placeholder="Sets" min="1" value="${sets}" required>
                <input type="number" class="exercise-reps" placeholder="Reps" min="1" value="${reps}" required>
                <div class="weight-input-group">
                    <button type="button" class="weight-adjust-btn" onclick="adjustWeight(this, -2.5)" ${isBw ? 'disabled' : ''}>-</button>
                    <input type="number" class="exercise-weight" placeholder="Weight" min="0" step="any" value="${weight}" ${isBw ? 'disabled' : ''} required>
                    <button type="button" class="weight-adjust-btn" onclick="adjustWeight(this, 2.5)" ${isBw ? 'disabled' : ''}>+</button>
                    <select class="exercise-unit" onchange="toggleWeightInput(this)">
                        <option value="kg" ${unit === 'kg' ? 'selected' : ''}>kg</option>
                        <option value="bw" ${unit === 'bw' ? 'selected' : ''}>Bodyweight</option>
                    </select>
                </div>
            `;
        }
        
        function addExerciseField(isFirst = false, container = exercisesContainer) {
            const newExerciseGroup = document.createElement('div');
            newExerciseGroup.className = 'exercise-group';
            let html = createExerciseFieldHtml();
            if (!isFirst && container === exercisesContainer) {
                html += `<button type="button" class="remove-exercise-btn" onclick="this.parentElement.remove()">X</button>`;
            }
            newExerciseGroup.innerHTML = html;
            container.appendChild(newExerciseGroup);
        }

        function resetAndAddFirstExercise() {
            exercisesContainer.innerHTML = '';
            addExerciseField(true);
        }

        function toggleWeightInput(selectElement) {
            const weightGroup = selectElement.closest('.weight-input-group');
            const weightInput = weightGroup.querySelector('.exercise-weight');
            const adjustButtons = weightGroup.querySelectorAll('.weight-adjust-btn');

            if (selectElement.value === 'bw') {
                weightInput.disabled = true; weightInput.value = ''; weightInput.required = false;
                adjustButtons.forEach(btn => btn.disabled = true);
            } else {
                weightInput.disabled = false; weightInput.required = true;
                adjustButtons.forEach(btn => btn.disabled = false);
            }
        }

        function adjustWeight(button, amount) {
            const weightInput = button.parentElement.querySelector('.exercise-weight');
            if (weightInput.disabled) return;
            let currentValue = parseFloat(weightInput.value) || 0;
            let newValue = Math.max(0, currentValue + amount);
            weightInput.value = Math.round(newValue * 100) / 100;
        }
        
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const exercises = [];
            document.querySelectorAll('#exercises-container .exercise-group').forEach(group => {
                const name = group.querySelector('.exercise-name').value.trim();
                const unit = group.querySelector('.exercise-unit').value;
                const weightValue = group.querySelector('.exercise-weight').value;
                const weight = unit === 'bw' ? 0 : parseFloat(weightValue);
                if (name && !isNaN(weight)) {
                     exercises.push({ name, sets: parseInt(group.querySelector('.exercise-sets').value), reps: parseInt(group.querySelector('.exercise-reps').value), weight, unit });
                }
            });
            if (exercises.length === 0) return;
            saveWorkout({ date: dateInput.value, type: typeInput.value, exercises });
            this.reset();
            setInitialDate();
            resetAndAddFirstExercise();
        });

        // --- Data Handling Functions ---
        function saveWorkout(workout) {
            const transaction = db.transaction("workouts", "readwrite");
            const store = transaction.objectStore("workouts");
            const request = workout.id ? store.put(workout) : store.add(workout);
            transaction.oncomplete = () => {
                console.log("Workout saved/updated successfully.");
                recalculateAllPRs();
            };
            transaction.onerror = (e) => console.error("Save/Update transaction failed:", e.target.error);
        }
        
        function deleteWorkout(workoutId) {
            if (!confirm("Are you sure you want to delete this workout?")) return;
            const transaction = db.transaction("workouts", "readwrite");
            transaction.objectStore("workouts").delete(workoutId);
            transaction.oncomplete = () => {
                console.log(`Workout ${workoutId} deleted.`);
                recalculateAllPRs();
            };
            transaction.onerror = (e) => console.error("Delete transaction failed:", e.target.error);
        }

        function recalculateAllPRs() {
            const transaction = db.transaction(['workouts', 'personalRecords'], 'readwrite');
            const workoutsStore = transaction.objectStore('workouts');
            const prStore = transaction.objectStore('personalRecords');
            const getAllRequest = workoutsStore.getAll();

            getAllRequest.onsuccess = () => {
                const allWorkouts = getAllRequest.result;
                const newPRs = {};
                allWorkouts.forEach(w => {
                    w.exercises.forEach(ex => {
                        if (ex.unit === 'kg') {
                            if (!newPRs[ex.name] || ex.weight > newPRs[ex.name].weight) {
                                newPRs[ex.name] = { exerciseName: ex.name, weight: ex.weight, date: w.date };
                            }
                        }
                    });
                });
                const clearRequest = prStore.clear();
                clearRequest.onsuccess = () => {
                    Object.values(newPRs).forEach(pr => prStore.put(pr));
                };
            };
            transaction.oncomplete = () => {
                console.log("PRs recalculated.");
                loadWorkouts();
                loadAllTimeHistory();
                loadPRs();
            };
        }

        // --- Display & Edit Functions ---
        function getWeekBounds(date) {
            const d = new Date(date);
            const day = d.getDay(); // Sunday - 0, Monday - 1, ...
            const diff = d.getDate() - day;
            const startOfWeek = new Date(d.setDate(diff));
            startOfWeek.setHours(0, 0, 0, 0); // Start of Sunday
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999); // End of Saturday
            return { start: startOfWeek, end: endOfWeek };
        }

        function loadWorkouts() {
            const request = db.transaction("workouts", "readonly").objectStore("workouts").getAll();
            request.onsuccess = () => {
                const today = new Date();
                const { start, end } = getWeekBounds(today);
                
                const workouts = request.result.filter(w => {
                    const workoutDate = new Date(w.date);
                    // Adjust for timezone offset to compare dates correctly
                    workoutDate.setMinutes(workoutDate.getMinutes() + workoutDate.getTimezoneOffset());
                    return workoutDate >= start && workoutDate <= end;
                }).sort((a, b) => b.date.localeCompare(a.date));
                
                document.querySelectorAll('#main-app-view .history-list').forEach(list => list.innerHTML = '');

                workouts.forEach(workout => {
                    const category = workout.type || 'strength';
                    const container = document.querySelector(`#${category}-history .history-list`);
                    if (container) {
                        const workoutEl = document.createElement('div');
                        workoutEl.innerHTML = renderWorkoutItem(workout);
                        container.appendChild(workoutEl.firstChild);
                    }
                });
                
                document.querySelectorAll('#main-app-view .history-list').forEach(list => {
                    if (list.innerHTML === '') {
                        list.innerHTML = `<p class="empty-state">No workouts logged this week.</p>`;
                    }
                });
            };
        }

        function renderWorkoutItem(workout, isEditing = false) {
            const workoutId = workout.id;
            let content;
            if (isEditing) {
                const exercisesHtml = workout.exercises.map(ex => `<div class="exercise-group">${createExerciseFieldHtml(ex)}</div>`).join('');
                content = `
                    <div class="workout-item-header"> 
                        <input type="date" value="${workout.date}" class="editing-date">
                        <select class="editing-type">
                            <option value="strength" ${workout.type === 'strength' ? 'selected' : ''}>Strength</option>
                            <option value="stretch" ${workout.type === 'stretch' ? 'selected' : ''}>Stretch</option>
                            <option value="pump" ${workout.type === 'pump' ? 'selected' : ''}>Pump</option>
                        </select>
                    </div>
                    <div class="editing-exercises-container">${exercisesHtml}</div>
                    <div class="edit-controls">
                        <button onclick="saveEditedWorkout(${workoutId})">Save Changes</button>
                        <button onclick="loadWorkouts(); loadAllTimeHistory();">Cancel</button>
                    </div>`;
            } else {
                const exercisesHtml = workout.exercises.map(ex => {
                    const weightDisplay = ex.unit === 'bw' ? 'Bodyweight' : `${ex.weight} kg`;
                    return `<li onclick="viewProgression('${ex.name}', '${workout.type}')" title="Click to see progression for ${ex.name}"><strong>${ex.name}:</strong> ${ex.sets} sets of ${ex.reps} reps @ ${weightDisplay}</li>`;
                }).join('');
                content = `
                    <div class="workout-item-header">
                        <h4>Workout on ${workout.date}</h4>
                        <div>
                            <button class="action-btn edit-btn" onclick="toggleEditMode(${workoutId})">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteWorkout(${workoutId})">Delete</button>
                        </div>
                    </div>
                    <ul>${exercisesHtml}</ul>`;
            }
            return `<div class="workout-item" id="workout-item-${workoutId}">${content}</div>`;
        }

        function toggleEditMode(workoutId) {
            const request = db.transaction("workouts", "readonly").objectStore("workouts").get(workoutId);
            request.onsuccess = () => {
                const workoutItemElement = document.getElementById(`workout-item-${workoutId}`);
                if(workoutItemElement) {
                    workoutItemElement.innerHTML = renderWorkoutItem(request.result, true);
                }
            };
        }

        function saveEditedWorkout(workoutId) {
            const workoutItemElement = document.getElementById(`workout-item-${workoutId}`);
            const newDate = workoutItemElement.querySelector('.editing-date').value;
            const newType = workoutItemElement.querySelector('.editing-type').value;
            const exercises = [];
            workoutItemElement.querySelectorAll('.editing-exercises-container .exercise-group').forEach(group => {
                const name = group.querySelector('.exercise-name').value.trim();
                const unit = group.querySelector('.exercise-unit').value;
                const weightValue = group.querySelector('.exercise-weight').value;
                const weight = unit === 'bw' ? 0 : parseFloat(weightValue);
                if (name && !isNaN(weight)) {
                    exercises.push({ name, sets: parseInt(group.querySelector('.exercise-sets').value), reps: parseInt(group.querySelector('.exercise-reps').value), weight, unit });
                }
            });
            if (exercises.length > 0) saveWorkout({ id: workoutId, date: newDate, type: newType, exercises });
        }

        function loadPRs() {
            const request = db.transaction("personalRecords", "readonly").objectStore("personalRecords").getAll();
            request.onsuccess = () => {
                const prs = request.result.sort((a, b) => a.exerciseName.localeCompare(b.exerciseName));
                prTableBody.innerHTML = prs.length === 0
                    ? `<tr><td colspan="3" class="empty-state">No personal records set yet.</td></tr>`
                    : prs.map(pr => `<tr><td>${pr.exerciseName}</td><td>${pr.weight} kg</td><td>${pr.date}</td></tr>`).join('');
            };
        }
        
        // --- Charting Functions ---
        function viewProgression(exerciseName, workoutType) {
            const request = db.transaction("workouts", "readonly").objectStore("workouts").getAll();
            request.onsuccess = () => {
                currentProgressionData = [];
                request.result.forEach(w => {
                    if (w.type === workoutType) {
                        w.exercises.forEach(ex => {
                            if (ex.name === exerciseName) {
                                currentProgressionData.push({ date: w.date, weight: ex.unit === 'kg' ? ex.weight : 0, totalReps: ex.sets * ex.reps });
                            }
                        });
                    }
                });
                currentProgressionData.sort((a, b) => a.date.localeCompare(b.date));
                
                const typeDisplayMap = { strength: 'Strength', stretch: 'Stretch', pump: 'Pump' };
                const typeDisplayName = typeDisplayMap[workoutType] || 'Workout';

                document.getElementById('chart-title').innerText = `Progression for ${exerciseName} (${typeDisplayName})`;
                currentChartType === 'weight' ? showWeightChart() : showRepsChart();
                chartModal.style.display = 'flex';
            };
        }

        function showWeightChart() {
            currentChartType = 'weight';
            const labels = currentProgressionData.map(d => d.date);
            const data = currentProgressionData.map(d => d.weight);
            renderChart(labels, data, 'Weight (kg)', currentChartStyle);
        }

        function showRepsChart() {
            currentChartType = 'reps';
            const labels = currentProgressionData.map(d => d.date);
            const data = currentProgressionData.map(d => d.totalReps);
            renderChart(labels, data, 'Total Reps', currentChartStyle);
        }

        function setChartStyle(style) {
            currentChartStyle = style;
            currentChartType === 'weight' ? showWeightChart() : showRepsChart();
        }

        function renderChart(labels, data, yAxisLabel, style) {
            const ctx = document.getElementById('progression-chart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            Chart.defaults.color = '#a0a0a0';
            Chart.defaults.borderColor = '#444850';

            let config = {
                data: { labels, datasets: [{ label: yAxisLabel, data }] },
                options: {
                    scales: { 
                        y: { beginAtZero: true, title: { display: true, text: yAxisLabel, color: '#e1e1e1' } },
                        x: { title: { color: '#e1e1e1' } }
                    },
                    plugins: { legend: { labels: { color: '#e1e1e1' } } },
                    responsive: true, maintainAspectRatio: true
                }
            };

            const accentColor = 'rgba(255, 152, 0, 1)'; // Orange
            const accentBgColor = 'rgba(255, 152, 0, 0.5)';
            const accentGradientStart = 'rgba(255, 152, 0, 0.4)';
            const accentGradientEnd = 'rgba(255, 152, 0, 0)';

            switch(style) {
                case 'bar':
                    config.type = 'bar';
                    config.data.datasets[0].backgroundColor = accentBgColor;
                    config.data.datasets[0].borderColor = accentColor;
                    config.data.datasets[0].borderWidth = 1;
                    break;
                default: // 'fancy'
                    config.type = 'line';
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, accentGradientStart);
                    gradient.addColorStop(1, accentGradientEnd);
                    config.data.datasets[0].backgroundColor = gradient;
                    config.data.datasets[0].borderColor = accentColor;
                    config.data.datasets[0].fill = true;
                    config.data.datasets[0].tension = 0.3;
                    config.data.datasets[0].pointBackgroundColor = '#fff';
                    config.data.datasets[0].pointBorderColor = accentColor;
                    config.data.datasets[0].pointRadius = 5;
                    break;
            }
            chartInstance = new Chart(ctx, config);
        }

        function closeModal() {
            chartModal.style.display = 'none';
        }

        // --- All-Time History View Logic ---
        function showMainView() {
            mainAppView.style.display = 'block';
            allTimeHistoryView.style.display = 'none';
        }

        function showHistoryView() {
            mainAppView.style.display = 'none';
            allTimeHistoryView.style.display = 'block';
            loadAllTimeHistory();
        }

        function setupHistoryEventListeners() {
            filterTypeEl.addEventListener('change', loadAllTimeHistory);
            sortDateEl.addEventListener('change', loadAllTimeHistory);
            searchExerciseEl.addEventListener('input', loadAllTimeHistory);
        }

        function loadAllTimeHistory() {
            const transaction = db.transaction('workouts', 'readonly');
            const store = transaction.objectStore('workouts');
            const request = store.getAll();

            request.onsuccess = () => {
                let workouts = request.result;
                const filterType = filterTypeEl.value;
                const sortDate = sortDateEl.value;
                const searchTerm = searchExerciseEl.value.toLowerCase();

                // 1. Filter by Type
                if (filterType !== 'all') {
                    workouts = workouts.filter(w => w.type === filterType);
                }

                // 2. Filter by Search Term
                if (searchTerm) {
                    workouts = workouts.filter(w => 
                        w.exercises.some(ex => ex.name.toLowerCase().includes(searchTerm))
                    );
                }

                // 3. Sort by Date
                workouts.sort((a, b) => {
                    if (sortDate === 'newest') {
                        return b.date.localeCompare(a.date);
                    } else {
                        return a.date.localeCompare(b.date);
                    }
                });

                // Render the filtered list
                if (workouts.length > 0) {
                    allTimeHistoryList.innerHTML = workouts.map(w => renderWorkoutItem(w)).join('');
                } else {
                    allTimeHistoryList.innerHTML = `<p class="empty-state">No workouts match your filters.</p>`;
                }
            };
        }

    </script>

</body>
</html>
